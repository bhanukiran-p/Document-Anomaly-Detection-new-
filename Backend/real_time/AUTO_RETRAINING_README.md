# Automatic Model Retraining System

## Overview

The Real-Time Fraud Detection system now includes **automatic model retraining** that continuously improves fraud detection accuracy as more labeled data accumulates in your Supabase database.

## How It Works

### 1. **Data Collection**
- Every time you analyze transactions, they are automatically saved to the Supabase `analyzed_real_time_trn` table
- Each transaction includes fraud labels (`is_fraud` column) generated by the ML model
- The database acts as your **training data repository** with unlimited storage

### 2. **Automatic Monitoring**
- A background scheduler checks the database **every hour** for new data
- It compares the current database size to the last training dataset size
- When sufficient new data accumulates, retraining is triggered automatically

### 3. **Retraining Triggers**
Automatic retraining occurs when **all** these conditions are met:
- **500+ new transactions** have been added since last training
- **50+ fraud samples** are available in total
- **No retraining is currently in progress**

### 4. **Training Process**
- Fetches all labeled transactions from Supabase
- Uses ensemble ML (60% Random Forest + 40% Gradient Boosting)
- Automatically adjusts model complexity based on dataset size
- Saves the new model and performance metrics
- Logs the retraining event with full statistics

## Configuration

### Retraining Parameters

You can customize the retraining behavior in `auto_retrainer.py`:

```python
RETRAIN_CHECK_INTERVAL = 3600  # Check every hour (in seconds)
MIN_NEW_SAMPLES_FOR_RETRAIN = 500  # Minimum new samples to trigger retraining
MIN_FRAUD_SAMPLES = 50  # Minimum total fraud samples required
```

### Automatic Startup

The retraining scheduler **starts automatically** when you run the API server:

```bash
cd Backend
python api_server.py
```

You'll see:
```
Starting automatic model retraining scheduler...
Automatic retraining scheduler started successfully
```

## API Endpoints

### 1. Get Retraining Status
```http
GET /api/real-time/auto-retrain/status
```

**Response:**
```json
{
  "success": true,
  "status": {
    "is_running": true,
    "retraining_in_progress": false,
    "last_check": "2025-01-15T10:30:00",
    "last_retrain": "2025-01-15T08:00:00",
    "check_interval_seconds": 3600,
    "min_new_samples": 500,
    "min_fraud_samples": 50
  }
}
```

### 2. Start Automatic Retraining
```http
POST /api/real-time/auto-retrain/start
```

**Response:**
```json
{
  "success": true,
  "message": "Automatic retraining started",
  "status": { ... }
}
```

### 3. Stop Automatic Retraining
```http
POST /api/real-time/auto-retrain/stop
```

**Response:**
```json
{
  "success": true,
  "message": "Automatic retraining stopped"
}
```

### 4. Trigger Manual Retraining Check
```http
POST /api/real-time/auto-retrain/trigger
```

Forces an immediate check and retraining if conditions are met.

**Response:**
```json
{
  "success": true,
  "message": "Retraining started",
  "stats": {
    "total_samples": 2500,
    "fraud_samples": 125,
    "new_samples": 600,
    "last_train_samples": 1900
  }
}
```

### 5. Retrain from Database (Manual)
```http
POST /api/real-time/retrain-from-database
```

Manually trigger a full retraining from all database data (bypasses automatic conditions).

**Response:**
```json
{
  "success": true,
  "message": "Model retrained successfully from database",
  "training_results": {
    "samples": 2500,
    "fraud_samples": 125,
    "legitimate_samples": 2375,
    "fraud_percentage": 5.0,
    "metrics": {
      "accuracy": 0.94,
      "precision": 0.89,
      "recall": 0.91,
      "f1_score": 0.90,
      "auc": 0.95
    },
    "trained_at": "2025-01-15T10:45:00"
  }
}
```

## Frontend Integration

The frontend API service ([api.js](../../Frontend/src/services/api.js)) includes functions to control retraining:

```javascript
import {
  getAutoRetrainingStatus,
  startAutoRetraining,
  stopAutoRetraining,
  triggerManualRetrainingCheck,
  retrainFromDatabase
} from '../services/api';

// Get current status
const status = await getAutoRetrainingStatus();
console.log('Auto-retrain status:', status);

// Manually trigger retraining from database
const result = await retrainFromDatabase();
console.log('Retraining complete:', result);

// Trigger a manual check (if conditions are met, retraining starts)
const checkResult = await triggerManualRetrainingCheck();
console.log('Manual check:', checkResult);
```

## Model Metadata & History

Retraining events are saved to `Backend/real_time/models/model_metadata.json`:

```json
{
  "trained_at": "2025-01-15T10:45:00",
  "training_samples": 2500,
  "metrics": {
    "accuracy": 0.94,
    "auc": 0.95,
    "precision": 0.89,
    "recall": 0.91,
    "f1_score": 0.90
  },
  "model_version": "1.0",
  "last_auto_retrain": "2025-01-15T10:45:00",
  "retraining_history": [
    {
      "timestamp": "2025-01-15T10:45:00",
      "samples": 2500,
      "fraud_samples": 125,
      "metrics": { ... },
      "trigger": "automatic"
    },
    ...
  ]
}
```

## Benefits

1. **Continuous Improvement**: Model accuracy improves automatically as you analyze more transactions
2. **No Manual Intervention**: Retraining happens in the background without user action
3. **Data-Driven**: Only retrains when sufficient new data is available
4. **Transparent**: Full logging and metadata tracking of all retraining events
5. **Scalable**: Leverages Supabase database for unlimited training data storage
6. **Adaptive**: Model complexity automatically adjusts based on dataset size

## Monitoring & Logs

The system logs all retraining activities:

```
2025-01-15 10:45:00 - INFO - Checking for new training data in database...
2025-01-15 10:45:01 - INFO - ===========================================================
2025-01-15 10:45:01 - INFO - AUTOMATIC MODEL RETRAINING STARTED
2025-01-15 10:45:01 - INFO - ===========================================================
2025-01-15 10:45:05 - INFO - Training with 150 estimators for 2500 samples
2025-01-15 10:45:45 - INFO - Model trained - Accuracy: 0.940, AUC: 0.950
2025-01-15 10:45:46 - INFO - ===========================================================
2025-01-15 10:45:46 - INFO - AUTOMATIC MODEL RETRAINING COMPLETED SUCCESSFULLY
2025-01-15 10:45:46 - INFO - Training samples: 2500
2025-01-15 10:45:46 - INFO - Fraud samples: 125
2025-01-15 10:45:46 - INFO - Model AUC: 0.950
2025-01-15 10:45:46 - INFO - Model Accuracy: 0.940
2025-01-15 10:45:46 - INFO - ===========================================================
```

## Best Practices

1. **Monitor Initial Performance**: Check retraining logs to ensure the model is improving
2. **Adjust Thresholds**: If retraining happens too frequently or not enough, adjust `MIN_NEW_SAMPLES_FOR_RETRAIN`
3. **Database Maintenance**: Regularly review fraud labels in the database for accuracy
4. **Manual Review**: Periodically review automatically labeled transactions and correct any errors
5. **Performance Tracking**: Monitor the `model_metadata.json` file to track model performance over time

## Troubleshooting

### Retraining Not Starting
- Check database has sufficient data: `total_samples >= 100` and `fraud_samples >= 50`
- Verify new samples have accumulated: `new_samples >= 500`
- Check logs for errors in database connection

### Low Model Accuracy
- Ensure fraud labels in database are accurate
- Consider manual review and correction of labeled data
- Manually retrain with verified labeled data using `/api/real-time/retrain-model`

### Performance Issues
- Increase `RETRAIN_CHECK_INTERVAL` to reduce database query frequency
- Increase `MIN_NEW_SAMPLES_FOR_RETRAIN` to reduce retraining frequency
- Monitor server resources during retraining (CPU/memory usage)

## Architecture Summary

```
┌─────────────────────────────────────────────────────────────┐
│                    Transaction Analysis                      │
│  (User uploads CSV → Fraud Detection → Save to Database)    │
└───────────────────────┬─────────────────────────────────────┘
                        │
                        ↓
┌─────────────────────────────────────────────────────────────┐
│              Supabase Database (Training Data)               │
│           Table: analyzed_real_time_trn                      │
│  Columns: transaction_id, amount, is_fraud, fraud_reason... │
└───────────────────────┬─────────────────────────────────────┘
                        │
                        ↓
┌─────────────────────────────────────────────────────────────┐
│             Auto-Retraining Scheduler (Hourly)               │
│  • Checks for new data                                       │
│  • Triggers retraining when thresholds met                   │
│  • Runs in background thread                                 │
└───────────────────────┬─────────────────────────────────────┘
                        │
                        ↓
┌─────────────────────────────────────────────────────────────┐
│                   Model Training Process                      │
│  • Fetch all labeled data from database                      │
│  • Train ensemble ML model (RF + GB)                         │
│  • Evaluate performance metrics                              │
│  • Save new model + metadata                                 │
└───────────────────────┬─────────────────────────────────────┘
                        │
                        ↓
┌─────────────────────────────────────────────────────────────┐
│                  Updated Fraud Detection                      │
│  • New model is used for all future analyses                 │
│  • Improved accuracy from accumulated data                   │
└─────────────────────────────────────────────────────────────┘
```

## Files Modified/Created

1. **NEW**: `Backend/real_time/auto_retrainer.py` - Main auto-retraining scheduler
2. **MODIFIED**: `Backend/api_server.py` - Added 5 new API endpoints
3. **MODIFIED**: `Frontend/src/services/api.js` - Added 5 new API functions
4. **MODIFIED**: `Backend/real_time/model_trainer.py` - Already supports database fetching

---

**Questions or Issues?**
Check the API server logs for detailed information about retraining events and any errors that occur.
